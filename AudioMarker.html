<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Marker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

<div class="w-full max-w-4xl bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
    <!-- Header -->
    <header class="text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-white">Audio Marker Pro</h1>
        <p class="text-gray-400 mt-2">Analyze audio for beats and add lyric markers.</p>
    </header>

    <!-- Main Content Area -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- Left Panel: Controls & Input -->
        <div class="bg-gray-700/50 rounded-xl p-6 space-y-6">
            <!-- File Uploader -->
            <div>
                <label for="audio-file" class="block text-sm font-medium text-gray-300 mb-2">1. Upload Audio File</label>
                <input type="file" id="audio-file" accept="audio/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 transition">
            </div>

            <!-- Audio Player -->
            <div id="player-container" class="hidden space-y-2">
                <audio id="audio-player" controls class="w-full"></audio>
                <p id="time-display" class="text-center text-sm text-gray-400">Current Time: 0.00s</p>
            </div>

            <!-- Lyric Input -->
            <div id="lyric-marker-container" class="hidden">
                <h3 class="text-lg font-semibold mb-3">2. Add Lyric Markers</h3>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="lyric-input" placeholder="Enter lyric..." class="flex-grow bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                    <button id="add-lyric-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                        Add Lyric at Time
                    </button>
                </div>
            </div>

            <!-- Analyze Button -->
            <div class="pt-4">
                <button id="analyze-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed disabled:transform-none" disabled>
                    3. Analyze & Generate Markers
                </button>
            </div>
            <!-- Loading Indicator -->
            <div id="loader" class="hidden flex flex-col items-center justify-center text-center space-y-2">
                <div class="loader"></div>
                <p class="text-gray-400">Analyzing audio... Please wait.</p>
            </div>
        </div>

        <!-- Right Panel: Output -->
        <div class="bg-gray-700/50 rounded-xl p-6 flex flex-col">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-semibold">4. Generated Output (JSON)</h3>
                <button id="copy-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded-lg text-sm transition disabled:opacity-50" disabled>Copy</button>
            </div>
            <pre id="output" class="flex-grow bg-gray-900 rounded-lg p-4 text-sm text-green-300 overflow-auto custom-scrollbar whitespace-pre-wrap break-words">Awaiting analysis...</pre>
        </div>
    </div>
</div>

<script>
    // --- DOM Element References ---
    const audioFileInput = document.getElementById('audio-file');
    const audioPlayer = document.getElementById('audio-player');
    const playerContainer = document.getElementById('player-container');
    const timeDisplay = document.getElementById('time-display');
    const lyricMarkerContainer = document.getElementById('lyric-marker-container');
    const lyricInput = document.getElementById('lyric-input');
    const addLyricBtn = document.getElementById('add-lyric-btn');
    const analyzeBtn = document.getElementById('analyze-btn');
    const outputPre = document.getElementById('output');
    const copyBtn = document.getElementById('copy-btn');
    const loader = document.getElementById('loader');

    // --- State Management ---
    let audioContext;
    let audioBuffer;
    let userLyrics = []; // Stores { time: 1.23, value: "Hello" }

    const TICKS_PER_SECOND = 20;

    // --- Initialization ---
    window.AudioContext = window.AudioContext || window.webkitAudioContext;

    // --- Event Listeners ---
    audioFileInput.addEventListener('change', handleFileSelect);
    addLyricBtn.addEventListener('click', handleAddLyric);
    analyzeBtn.addEventListener('click', handleAnalysis);
    copyBtn.addEventListener('click', handleCopy);
    audioPlayer.addEventListener('timeupdate', updateTimeDisplay);

    /**
     * Handles the user selecting an audio file.
     * Loads the file into the audio player and prepares it for analysis.
     */
    async function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Reset state
        resetUI();

        // Show player and lyric input
        playerContainer.classList.remove('hidden');
        lyricMarkerContainer.classList.remove('hidden');
        audioPlayer.src = URL.createObjectURL(file);

        // Decode audio data for analysis
        try {
            audioContext = new AudioContext();
            const arrayBuffer = await file.arrayBuffer();
            audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            analyzeBtn.disabled = false;
            outputPre.textContent = 'Audio loaded. Add lyrics or click Analyze.';
        } catch (error) {
            console.error("Error decoding audio file:", error);
            outputPre.textContent = `Error: Could not decode audio file. Please try a different format (e.g., MP3, WAV).`;
            analyzeBtn.disabled = true;
        }
    }

    /**
     * Resets the UI to its initial state.
     */
    function resetUI() {
        userLyrics = [];
        audioBuffer = null;
        if (audioContext) {
            audioContext.close();
            audioContext = null;
        }
        analyzeBtn.disabled = true;
        copyBtn.disabled = true;
        outputPre.textContent = 'Awaiting analysis...';
        playerContainer.classList.add('hidden');
        lyricMarkerContainer.classList.add('hidden');
        loader.classList.add('hidden');
    }

    /**
     * Updates the current time display as the audio plays.
     */
    function updateTimeDisplay() {
        timeDisplay.textContent = `Current Time: ${audioPlayer.currentTime.toFixed(2)}s`;
    }

    /**
     * Handles adding a lyric marker at the current playback time.
     */
    function handleAddLyric() {
        const lyricText = lyricInput.value.trim();
        if (!lyricText) {
            alert('Please enter a lyric.');
            return;
        }
        if (!audioPlayer.src) {
            alert('Please load an audio file first.');
            return;
        }

        const currentTime = audioPlayer.currentTime;
        userLyrics.push({ time: currentTime, type: 'lyric', value: lyricText });

        lyricInput.value = ''; // Clear input

        // Give feedback
        outputPre.textContent = `Added lyric "${lyricText}" at ${currentTime.toFixed(2)}s.\n` + outputPre.textContent;
        console.log('Current Lyrics:', userLyrics);
    }

    /**
     * Main function to start the beat detection and format the final output.
     */
    async function handleAnalysis() {
        if (!audioBuffer) {
            alert('No audio data available for analysis.');
            return;
        }

        loader.classList.remove('hidden');
        analyzeBtn.disabled = true;
        outputPre.textContent = 'Analyzing...';

        // Use a timeout to allow the UI to update before the heavy processing starts
        setTimeout(async () => {
            try {
                // 1. Detect beats from the audio buffer
                const beatEvents = await detectBeats(audioBuffer);

                // 2. Combine detected beats with user-added lyrics
                const allEvents = [...beatEvents, ...userLyrics];

                // 3. Sort all events by time
                allEvents.sort((a, b) => a.time - b.time);

                // 4. Format into the final tick-based JSON object
                const result = formatEventsToTicks(allEvents);

                // 5. Display the result
                outputPre.textContent = JSON.stringify(result, null, 2);
                copyBtn.disabled = false;
            } catch (error) {
                console.error("Analysis failed:", error);
                outputPre.textContent = "An error occurred during analysis.";
            } finally {
                loader.classList.add('hidden');
                analyzeBtn.disabled = false;
            }
        }, 50);
    }

    /**
     * Analyzes the audio buffer to detect prominent peaks (beats).
     * This is a simplified onset detection algorithm.
     * @param {AudioBuffer} buffer - The decoded audio data.
     * @returns {Promise<Array>} A promise that resolves to an array of beat events.
     */
    function detectBeats(buffer) {
        return new Promise(resolve => {
            const offlineContext = new OfflineAudioContext(buffer.numberOfChannels, buffer.length, buffer.sampleRate);
            const source = offlineContext.createBufferSource();
            source.buffer = buffer;

            // Create a low-pass filter to isolate bass/kick drum frequencies
            const filter = offlineContext.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 150; // Target frequencies below 150Hz
            filter.Q.value = 1;

            source.connect(filter);
            filter.connect(offlineContext.destination);
            source.start(0);

            offlineContext.startRendering().then(renderedBuffer => {
                const data = renderedBuffer.getChannelData(0);
                const beatEvents = [];
                const threshold = 0.6; // Sensitivity threshold (0 to 1)

                // The analysis window size (how many samples to check at once)
                const sampleWindow = Math.floor(buffer.sampleRate / 20);

                for (let i = 0; i < data.length; i += sampleWindow) {
                    let maxVal = 0;
                    for (let j = 0; j < sampleWindow && i + j < data.length; j++) {
                        maxVal = Math.max(maxVal, Math.abs(data[i + j]));
                    }

                    // If the max value in this window exceeds the threshold, mark it as a beat
                    if (maxVal > threshold) {
                        const time = i / buffer.sampleRate;
                        // To avoid duplicate beats very close to each other
                        if (beatEvents.length === 0 || (time - beatEvents[beatEvents.length - 1].time) > 0.2) {
                            beatEvents.push({ time: time, type: 'beat', value: 'B' });
                        }
                    }
                }
                resolve(beatEvents);
            });
        });
    }

    /**
     * Converts an array of timed events into the final tick-based JSON object.
     * @param {Array} events - Sorted array of events with 'time', 'type', and 'value'.
     * @returns {Object} The formatted JSON object.
     */
    function formatEventsToTicks(events) {
        const result = {};
        events.forEach(event => {
            const tick = Math.round(event.time * TICKS_PER_SECOND);

            if (!result[tick]) {
                result[tick] = {};
            }

            // Add the event, avoiding overwriting if a beat and lyric are on the same tick
            // e.g., "10": { "beat": "B", "lyric": "Hi" }
            result[tick][event.type] = event.value;
        });
        return result;
    }

    /**
     * Copies the content of the output to the clipboard.
     */
    function handleCopy() {
        const textToCopy = outputPre.textContent;
        // Use execCommand as a fallback for iframe environments
        const textArea = document.createElement('textarea');
        textArea.value = textToCopy;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            copyBtn.textContent = 'Copied!';
            setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000);
        } catch (err) {
            console.error('Failed to copy text: ', err);
            alert('Failed to copy text.');
        }
        document.body.removeChild(textArea);
    }

</script>
</body>
</html>
